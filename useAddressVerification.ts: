import { useCallback, useEffect, useState } from "react";
import { useAnchorWallet, useConnection } from "@solana/wallet-adapter-react";
import * as anchor from "@coral-xyz/anchor";
import { PublicKey, SystemProgram } from "@solana/web3.js";
import idl from "../target/idl/compliance_registry.json";
import { ADMIN_WALLETS } from "../config/admins";

const PROGRAM_ID = new PublicKey("YOUR_PROGRAM_ID_HERE");

export function useAddressVerification() {
  const wallet = useAnchorWallet();
  const { connection } = useConnection();
  const [program, setProgram] = useState<anchor.Program | null>(null);
  const [record, setRecord] = useState<any | null>(null);
  const [loading, setLoading] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);

  useEffect(() => {
    if (!wallet || !connection) return;
    const provider = new anchor.AnchorProvider(connection, wallet, {
      preflightCommitment: "processed",
    });
    const prog = new anchor.Program(idl as anchor.Idl, PROGRAM_ID, provider);
    setProgram(prog);

    // Check if wallet is an approved registry authority
    const isListed = ADMIN_WALLETS.some((a) => a.equals(wallet.publicKey));
    setIsAdmin(isListed);
  }, [wallet, connection]);

  const findPda = useCallback(
    async (user: PublicKey) =>
      PublicKey.findProgramAddress(
        [Buffer.from("address"), user.toBuffer()],
        PROGRAM_ID
      ),
    []
  );

  const getRecord = useCallback(
    async (user: PublicKey) => {
      if (!program) return;
      const [pda] = await findPda(user);
      try {
        const acc = await program.account.verifiedAddress.fetch(pda);
        setRecord(acc);
      } catch {
        setRecord(null);
      }
    },
    [program, findPda]
  );

  const verify = useCallback(
    async (targetUser: PublicKey) => {
      if (!program || !wallet || !isAdmin) return alert("Not authorized");
      setLoading(true);
      const registryAuthority = wallet.publicKey;
      const [verifiedPda] = await findPda(targetUser);

      await program.methods
        .verifyAddress()
        .accounts({
          registryAuthority,
          verifiedAddress: verifiedPda,
          user: targetUser,
          systemProgram: SystemProgram.programId,
        })
        .rpc();

      await getRecord(targetUser);
      setLoading(false);
    },
    [program, wallet, findPda, getRecord, isAdmin]
  );

  const revoke = useCallback(
    async (targetUser: PublicKey) => {
      if (!program || !wallet || !isAdmin) return alert("Not authorized");
      setLoading(true);
      const registryAuthority = wallet.publicKey;
      const [verifiedPda] = await findPda(targetUser);

      await program.methods
        .revokeAddress()
        .accounts({
          registryAuthority,
          verifiedAddress: verifiedPda,
          user: targetUser,
        })
        .rpc();

      await getRecord(targetUser);
      setLoading(false);
    },
    [program, wallet, findPda, getRecord, isAdmin]
  );

  return {
    program,
    record,
    verify,
    revoke,
    getRecord,
    isAdmin,
    loading,
  };
}
